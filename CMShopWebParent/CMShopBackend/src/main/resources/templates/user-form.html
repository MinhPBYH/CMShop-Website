<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments::page_head(${pageTitle})"/>
<body>
	<div class="container-fluid">
		<div th:replace="navigation::menu()"/>
		<div>
			<h2>Manager Users | [[${pageTitle}]]</h2>
		</div>
		<form th:action="@{/users/save}" method="post" class="col-lg-8 offset-lg-2 col-xl-6 offset-xl-3"
			th:object="${user}" onsubmit="return checkUniqueEmail(this);" enctype="multipart/form-data">
			<input type="hidden" id="id" th:field="*{id}">
			<div class="border border-secondary-subtle rounded p-3">
				<div class="row  my-3">
					<label class="col-sm-2 offset-sm-1 col-form-label " for="emailInput">E-mail</label>
					<div class="col-sm-9">
						<input type="email" tabindex="-1" class="form-control" id="emailInput" th:field="*{email}" required maxlength="128" minlength="8">
					</div>
				</div>
				
				<div class="row  my-3">
					<label class="col-sm-2 offset-sm-1 col-form-label " for="firstNameInput">First Name</label>
					<div class="col-sm-9">
						<input type="text" class="form-control" id="firstNameInput" th:field="*{firstName}" required maxlength="45" minlength="2">
					</div>
				</div>
				
				<div class="row  my-3">
					<label class="col-sm-2 offset-sm-1 col-form-label " for="lastNameInput">Last Name</label>
					<div class="col-sm-9">
						<input type="text" class="form-control" id="lastNameInput" th:field="*{lastName}" required maxlength="45" minlength="2">
					</div>
				</div>
				
				<div class="row  my-3">
					<label class="col-sm-2 offset-sm-1 col-form-label " for="passwordInput">Password</label>
					<div class="col-sm-9">
						<input type="password" th:if="${user.id == null}" class="form-control" id="passwordInput" th:field="*{password}" 
							required maxlength="20" minlength="8">
						<input type="password" th:if="${user.id != null}" class="form-control" id="passwordInput" th:field="*{password}" 
							maxlength="20" minlength="8" placeholder="Leave blank if you dont want to change password">
						
					</div>
				</div>
				
				<div class="row  my-3">
					<label class="col-sm-2 offset-sm-1 col-form-label" >Role</label>
					<div class="col-sm-9 pt-2">
						<div class="ms-2">
							<div th:each="role: ${listRoles}">
								<input class="me-1" type="checkbox" th:field="*{roles}" 
									th:text="${role.name}" th:value="${role.id} ">
								- <small class="fst-italic">[(${role.description})]</small>
								<br>
							</div>
						</div>
					</div>
				</div>
				<div class="row  my-3">
					<label class="col-sm-2 offset-sm-1 col-form-label " for="enable">Enable</label>
					<div class="col-sm-9 pt-2">
						<input class="ms-2" type="checkbox" id="enable" th:field="*{enabled}">
					</div>
				</div>
				<div class="row my-3">
					<label class="col-sm-2 offset-1 col-form-label	" for="fileImage">Photos</label>
					<div class="col-sm-9 ps-sm-4 pt-2">
						<div class="row">
							<div class="col-sm-6">
								<input type="hidden" th:field="*{photos}">
								<input type="file" id="fileImage" name="image" accept="image/png, image/jpeg">
							</div>
							<div class="col-sm-4 col-md-3 col-4 mt-3 mt-sm-0">
								<img id="thumnail" class="img-thumbnail img-fluid" alt="Photos preview" th:src="@{${user.photoImagePath}}">
							</div>	
						</div>						
					</div>
				</div>
				<div class="text-center">
					<input type="submit" value="Save" class="btn btn-primary me-3">
					<input type="button" value="Cancel" class="btn btn-secondary" id="buttonCancel">
				</div>
			</div>
		</form>
		
		<div class="modal fade mt-5" id="dupilicatedEmailDialog">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h4 class="modal-title text-danger" id="modalTitle"></h4>
						<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">
						<p id="modalMessage"></p>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>
		
		<div th:replace="fragments::copyright()"/>
	</div>
</body>
<script type="text/javascript">
	//note in html
	//enctype="multipart/form-data" ensures that the file is sent to the server
	
	
	$(document).ready(function(){
		$("#buttonCancel").on("click",function(){
			window.location.href = "[[@{/users}]]";
		});
		if($('#id').val() != ""){
			$('#emailInput').prop('readonly', true);
			$('#emailInput').focus(function(){
				$(this).css({
	                'outline': 'none',
	                'box-shadow': 'none',
	                'border-color': '#dee2e6'
           		});
			});
		}
		//when choose avatar or change avatar
		$("#fileImage").change(function(){
			//get size of image file with byte unit
			fileSize = this.files[0].size;
			// check file size > 1.5MB = 1.5 * 1024 * 1024 * 1.5 = 1572864
			// Image that you choose large than 1,5 Mb
			if(fileSize > 1572864){
				this.setCustomValidity("You must choose an image less than 1,5 Mb");
				this.reportValidity();

			}else{
				this.setCustomValidity("");
				showImageThumnail(this);
			}
		});
	});
	//show thumnail when user choose a image file from web
	function showImageThumnail(fileImageInput){
		// .files returns File list and file object at the index 0.
		let file = fileImageInput.files[0];
		//create a file reader object which can read content of the file
		let reader = new FileReader();
		// readAsDataURL() method begins to read url data of input file 
		
		// onload is an event activated when the file reading process is complete.
		// e.target.result contains readed data as a url data type. this url data type can be direct use like a thumnail   
		reader.onload = function(e){
			$('#thumnail').attr("src",e.target.result);
		};
		reader.readAsDataURL(file);
		
	}
	
	function checkUniqueEmail(form){
		let url = "[[@{/users/check_email}]]";
		let userEmail = $('#emailInput').val();
		let csrfValue = $("input[name='_csrf']").val();
		params = {email:userEmail, _csrf : csrfValue};
		
		if($('#id').val() != ""){
			form.submit();
		}else{
			$.post(url,params,function(res){
				if(res == "OK")
					form.submit();
				else if(res == "Duplicated"){
					showDuplicatedEmailDialog("Warning","There is other user having the email " + userEmail + " !!!");
				}else{
					showDuplicatedEmailDialog("Error","No response from the server!!!");
				}
			}).fail(function(){
				showDuplicatedEmailDialog("Error","Could not connect to the server!!!");
			});
		}

		
		
		return false;
	};
	
	function showDuplicatedEmailDialog(title, message){
		$('#modalTitle').text(title);
		$('#modalMessage').text(message);
		$("#dupilicatedEmailDialog").modal('show');
	};
	
</script>
</html>